#!/usr/bin/env bash
I3_PATH=${HOME}/.config/i3
CONFIG=${I3_PATH}/config
CONF_D_PATH=${I3_PATH}/conf.d
INCLUDES=${I3_PATH}/i3_config.inc

[[ -d $CONF_D_PATH ]] || error Missing directory: $CONF_D

error() {
  echo $@
  exit 1
}

is_file() {
  [[ -f $1 ]] || error Missing file: $1
}

is_file $INCLUDES

read_file() {
  egrep -v '^#|^$' $1
}

vars_first() {
  FIRST=$(read_file $1 | head -1)
  [[ "$FIRST" == "vars" ]] || {
    error vars not listed first in $1
  }
}

vars_first $INCLUDES

cat << EOF > $CONFIG
#### Do not edit this file, it is generated
#### Edit the files in $CONF_D_PATH
#### Then run $0 reload|restart

EOF

for i in $(read_file $INCLUDES); do
  is_file ${CONF_D_PATH}/$i
  cat ${CONF_D_PATH}/$i >> $CONFIG
done

case $1 in
  reload|restart)
    i3-msg $1
    ;;
esac
